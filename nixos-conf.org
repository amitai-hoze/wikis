#+LATEX_HEADER: \usepackage{parskip}
#+LATEX_HEADER: \usepackage{inconsolata}

#+TITLE:NixOS configuration file
#+AUTHOR:Amitai Hoze

* Main
:PROPERTIES:
:ID:       29b02e0a-9aa8-4d5d-8d5a-43ac7b5c1735
:END:
#+begin_src nix :noweb yes :tangle ~/org-mode/nixos/configuration.nix
{ pkgs, config, ... }: {
    nixpkgs.config.allowUnfree = true;
    nixpkgs.config.allowBroken = true;
    nixpkgs.config.allowTexliveBuilds =true;
    nixpkgs.system = "x86_64-linux";
    nix.maxJobs = 4;

    imports = [
        <nixpkgs/nixos/modules/installer/scan/not-detected.nix>
    ];

    hardware = {
        <<hardware>>
    };

    boot = {
        <<boot>>
    };

    fileSystems = {
        <<file-systems>>
    };

    swapDevices = [
        {
            label = "swap";
        }
    ];

    services = {
        <<services>>
    };

    users.extraUsers.amitai = {
        <<users>>
    };

    powerManagement = {
        enable = true;
        cpuFreqGovernor = "ondemand";
    };

    environment = {
        systemPackages = with pkgs; [
            <<games>>
            <<command-line-tools>>
            <<nix-tools>>
            <<misc>>
            <<media-players-viewers>>
            <<media-editors>>
            <<latex>>
            <<interpreters>>
            <<haskell>>
            <<java>>
            <<ides>>
            <<source-control>>
            <<internet>>
            <<math>>
            <<system-tools>>
        ];

        shellAliases = {
            <<shell-aliases>>
        };

        interactiveShellInit = ''
        <<interactive-shell-init>>
        '';
    };

    fonts = {
        enableFontDir = true;
        enableGhostscriptFonts = true;
        fonts = with pkgs; [
            <<fonts>>
        ];
    };
}
#+end_src

* Hardware 
:PROPERTIES:
:ID:       ffe178bc-3002-4027-99f7-0c2fb4145164
:END:

#+name: hardware
#+begin_src nix
bluetooth.enable = true;
pulseaudio.enable = true;
cpu.intel.updateMicrocode = true;
opengl.s3tcSupport = true;

bumblebee = {
    enable = true;
    group = "video";
};
#+end_src
* Boot
:PROPERTIES:
:ID:       42d050f5-cf82-48e0-bf93-ba85ea73c62a
:END:

#+name: boot
#+begin_src nix
initrd = {
    kernelModules = [ "ahci" "aesni-intel" "fbcon" "i915" ];
    availableKernelModules = [ "scsi_wait_scan" ];
};

kernelModules = [ "kvm-intel" "msr" ];

extraModprobeConfig = ''
options snd_hda_intel mode=auto power_save=1 index=1
'';


#blacklistedKernelModules = [ "snd_pcsp" "pcspkr" ];

loader.grub = {
    enable = true;
    version = 2;
    #device = "/dev/sda1";
    device = "nodev";
    memtest86.enable = false;
};
#+end_src
* File Systems
:PROPERTIES:
:ID:       7090625a-05d9-46ae-9ee4-e5f12596bbe8
:END:

#+name: file-systems
#+begin_src nix
"/" = {
    device = "/dev/disk/by-label/nixos";
    fsType = "ext4";
    options = "defaults,noatime,discard";
};
    
"/home/amitai/data1" = {
    device = "/dev/disk/by-label/Data1";
    fsType = "ntfs";
};

"/home/amitai/data2" = {
    device = "/dev/disk/by-label/Data2";
    fsType = "ntfs";
};
#+end_src
* Services
:PROPERTIES:
:ID:       e0899a47-aab2-46c7-b4a8-56827a4c9bc1
:END:

#+name: services
#+begin_src nix    
acpid.enable = true;
upower.enable = true;
    
xserver = {
    xkbModel = "asus_laptop";
    xkbOptions = "eurosign:e,terminate:ctrl_alt_bksp";
        
    #videoDrivers = [ "intel" "i965" "nvidia" ];
    vaapiDrivers = [ pkgs.vaapiIntel pkgs.vaapiVdpau ];
        
    resolutions = [{x = 1600; y = 900;}];
    defaultDepth = 24;
        
    synaptics = {
        enable = true;
    };
    enable = true;
    desktopManager.kde4.enable = true;
};
#+end_src
* Users
:PROPERTIES:
:ID:       b1c59348-47f5-42e5-abc3-d8bf1119fe6a
:END:

#+name: users
#+begin_src nix
isNormalUser = true;
home = "/home/amitai";
description = "Amitai Hoze";
extraGroups = [ "wheel" "networkmanager" ];
#+end_src
* Packages
** Games
:PROPERTIES:
:ID:       0305e0e0-298e-41cf-913a-88184364cd4b
:END:

#+name: games
#+begin_src nix
rili
kde4.ktuberling
# kde4.klines
# kde4.pairs
# asc
# bullet
#+end_src
** Command line tools
:PROPERTIES:
:ID:       6d4cb55a-9ca1-48bb-bfa1-a3205ca18f74
:END:

#+name: command-line-tools
#+begin_src nix
bc
zip
unzip
binutils
unoconv
#+end_src
** Nix tools
:PROPERTIES:
:ID:       e27cd13d-be27-430e-a245-d8e9309dd329
:END:

#+name: nix-tools
#+begin_src nix
nox
nix-prefetch-scripts
nix-repl
#+end_src
** Misc
:PROPERTIES:
:ID:       384d7586-b0f5-4a5e-93d4-5924db7d8e92
:END:

#+name: misc
#+begin_src nix
commonsCompress
dvdisaster
synergy
keepassx
kde4.kmymoney
kde4.k3b
#linuxPackages.virtualbox
#+end_src
** Media
*** Players and Viewers
:PROPERTIES:
:ID:       1f0e2380-ebfa-4e18-ae4b-4c3fbe5651c2
:END:

#+name: media-players-viewers
#+begin_src nix
vlc
kde4.gwenview
evince
#+end_src
*** Editors
:PROPERTIES:
:ID:       30913cba-cd57-4fba-a2c2-cbd56bf40413
:END:

#+name: media-editors
#+begin_src nix
kde4.ksnapshot
darktable
gimp
xournal
kde4.kolourpaint
pinta
subtitleeditor
aegisub
imagemagick
#libreoffice
#dia
#+end_src
** Latex
:PROPERTIES:
:ID:       d41b3e36-9c2f-48ef-9b73-b9de3e4a4625
:END:

#+name: latex
#+begin_src nix
(texLiveAggregationFun { paths = [ texLive texLiveExtra texLiveBeamer ]; })
#+end_src
** Development
*** Interperters
:PROPERTIES:
:ID:       faedc95b-2217-4ed3-b57f-2883be76039b
:END:

#+name: interpreters
#+begin_src nix
python
expect
tcl
#+end_src
*** Haskell
:PROPERTIES:
:ID:       740595ff-da44-41c5-88fb-728d45e5405f
:END:

#+name: haskell
#+begin_src nix
(haskellngPackages.ghcWithPackages
 (self : with self;
  [ pipes
    hint
    cabal-install
    diagrams diagrams-cairo diagrams-builder
    shelly
    random
    HaskellForMaths
    matrix
    aeson-pretty
    htoml
    HaTeX
    #yi - not working meanwhile
  ] ))
#+end_src
*** Java
:PROPERTIES:
:ID:       799576a9-527e-44d7-8e4f-e25446a4c414
:END:

#+name: java
#+begin_src nix
#oraclejdk8
#+end_src
*** Editors and IDEs
:PROPERTIES:
:ID:       5419fb15-5f0c-42d7-a54b-59df0ccf5883
:END:

#+name: ides
#+begin_src nix
emacs
idea.android-studio
#+end_src
*** Source Control
:PROPERTIES:
:ID:       8bef2816-a5ef-4cd1-bed2-bd27c4b419f3
:END:

#+name: source-control
#+begin_src nix
git
meld
#+end_src
** Internet
:PROPERTIES:
:ID:       e81a02c1-0762-4e1b-8067-7ca718344885
:END:

#+name: internet
#+begin_src nix
chromium
dropbox
aria
youtube-dl
telegram-cli
#+end_src
** Math
:PROPERTIES:
:ID:       7858ac8d-1d4d-4f39-ae7d-4bb2d66d0b04
:END:

#+name: math
#+begin_src nix
octave
maxima
#+end_src
** System Tools
:PROPERTIES:
:ID:       0dfede89-a46e-4a91-bf36-b4da96838561
:END:

#+name: system-tools
#+begin_src nix
unetbootin
gparted
#+end_src
* Shell Aliases
:PROPERTIES:
:ID:       f92cf89b-b0eb-476d-b0b1-baf7cb06e51e
:END:

#+name: shell-aliases
#+begin_src nix
ls = "ls --color=tty";
ll = "ls -l";
l = "ls -alh";
which = "type -P";
switch = "sudo nixos-rebuild switch -I nixpkgs=~/nixpkgs/";
list-installed = "nix-store -q --references /var/run/current-system/sw";
gm = "ghc --make";
ne = "nix-env -f ~/nixpkgs/";
fpo = "stat -c \"%a %n\"";
gs = "git status";
gd = "git diff";
orgmode-update = "git pull && make clean && make && make doc";
odt2org = "python ~/applications/odt2org/odt2org.py";
og = "open_gemara.sh";
n_h = "nautilus .";
e = "emacs";
pjsua = "/home/amitai/src/pjproject-2.3/pjsip-apps/bin/pjsua-x86_64-unknown-linux-gnu";
# Security measurements, see [[id:8d28664c-8660-49ae-88ea-eec585ace26e][Protecting files from deletion]]
cp = "cp -i";
mv = "mv -i";
rm = "rm -i";
rc = "~/scripts/mac/remote_command.sh";
ssh_h = "~/scripts/mac/ssh_here.sh";
cb = "carthage build --platform iOS --verbose";
cu = "carthage update --platform iOS --verbose";
crontab_log = "grep CRON /var/log/syslog";
tgz = "tar -zxvf";
gsct = "git show -s --format=%ci";
ydamp3 = "youtube-dl -x --audio-format mp3";
ydp = "youtube-dl -i";
#+end_src
* Shell init
:PROPERTIES:
:ID:       05ee2d6d-c724-410f-b4b0-4eddba20306d
:END:

#+name: interactive-shell-init
#+begin_src nix
export PATH=/home/amitai/org-mode/haskell/shelly_scripts:$PATH
export PATH=/home/amitai/org-mode/scripts:$PATH
export PATH=/home/amitai/org-mode/tcl:$PATH
export doconSource=/home/amitai/src/docon/docon/source
#export JAVA_HOME=dollar{pkgs.oraclejdk8.home}
#export JAVA_HOME=dollar{pkgs.jdk.home}
#+end_src
* Fonts
:PROPERTIES:
:ID:       738d5a2e-4d36-48a6-8a58-633a018ade65
:END:

#+name: fonts
#+begin_src nix
corefonts  # Micrsoft free fonts
inconsolata  # monospaced
ubuntu_font_family  # Ubuntu fonts
cm_unicode
#+end_src

